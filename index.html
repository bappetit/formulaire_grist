<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Formulaire Grist</title>
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 2rem auto; padding: 1rem; }
    input, select, button { width: 100%; padding: 0.6rem; margin-top: 0.5rem; }
    .success { color: green; }
    .error { color: red; }
    #description { font-style: italic; margin-top: 0.5rem; }
  </style>
</head>
<body>

<h3>Soumettre vos informations</h3>

<input id="nom" type="text" placeholder="Nom" required>
<input id="email" type="email" placeholder="Email" required>

<select id="choix">
  <option value="">Chargement...</option>
</select>

<p id="description"></p>

<button id="submitBtn">Envoyer</button>

<p id="message"></p>

<script>
const workerUrl = "https://workergrist.baptiste-petit.workers.dev/";

const message = document.getElementById("message");
const select = document.getElementById("choix");
const description = document.getElementById("description");

// On garde les enregistrements ici
let recordsList = [];

fetch(workerUrl)
  .then(res => res.json())
  .then(records => {
    recordsList = records
      .filter (r => {
        if (r.fields.Inscrits >= r.fields.Maximum ) return false; 
        if (r.fields.Passe_) return false; 
      }); // sauvegarde
    
    select.innerHTML = '<option value="">-- Choisissez une option --</option>';
    
    records.forEach(r => {
      const option = document.createElement("option");
      option.value = r.fields.Titre;      // Nom √† afficher / valeur
      option.textContent = r.fields.Titre; 
      select.appendChild(option);
    });
  })
  .catch(err => {
    message.textContent = "‚ùå Impossible de charger la liste";
    message.className = "error";
  });

// Affichage de la description quand le choix change
select.addEventListener("change", () => {
  const selected = select.value;
  if (!selected) {
    description.textContent = "";
    return;
  }

  const record = recordsList.find(r => r.fields.Titre === selected);
  if (record && record.fields.Description) {
    description.textContent = record.fields.Description;
  } else {
    description.textContent = "";
  }
});

// üü¢ Envoi du formulaire
document.getElementById("submitBtn").addEventListener("click", async () => {
  const nom = document.getElementById("nom").value;
  const email = document.getElementById("email").value;
  const choix = document.getElementById("choix").value;

  if (!nom || !email || !choix) {
    message.textContent = "‚ùå Remplissez tous les champs";
    message.className = "error";
    return;
  }

  try {
    const res = await fetch(workerUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nom, email, choix })
    });

    const result = await res.json();

    if (res.ok) {
      message.textContent = "‚úÖ Donn√©es envoy√©es avec succ√®s !";
      message.className = "success";
      document.getElementById("nom").value = "";
      document.getElementById("email").value = "";
      document.getElementById("choix").value = "";
      description.textContent = "";
    } else {
      message.textContent = "‚ùå Erreur : " + (result.error || "inconnue");
      message.className = "error";
    }
  } catch (err) {
    message.textContent = "‚ùå Erreur r√©seau";
    message.className = "error";
  }
});
</script>

</body>
</html>
